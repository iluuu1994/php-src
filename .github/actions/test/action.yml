name: Test
inputs:
  run-tests-parameters:
    default: ''
    required: false
runs:
  using: composite
  steps:
    - shell: bash
      run: |
        if [ "$ARCH" != "macos" ]; then
          export MYSQL_TEST_USER=root
          export MYSQL_TEST_PASSWD=root
          export PDO_MYSQL_TEST_DSN="mysql:host=localhost;dbname=test"
          export PDO_MYSQL_TEST_USER=root
          export PDO_MYSQL_TEST_PASS=root
          export PDO_DBLIB_TEST_DSN="dblib:host=127.0.0.1;dbname=master;version=7.0"
          export PDO_DBLIB_TEST_USER="pdo_test"
          export PDO_DBLIB_TEST_PASS="password"
        fi
        if [ "$ARCH" == "macos" ]; then
          export CI_NO_IPV6=1
        fi
        export REPORT_EXIT_STATUS=no
        export SKIP_IO_CAPTURE_TESTS=1
        sapi/cli/php run-tests.php -P -q ${{ inputs.run-tests-parameters }} \
          -j$(${{ env.ARCH != 'macos' && '/usr/bin/nproc' || 'sysctl -n hw.logicalcpu' }}) \
          -g FAIL,XFAIL,BORK,WARN,LEAK,XLEAK,SKIP \
          --offline \
          --show-diff \
          --show-slow 1000 \
          --set-timeout 120
